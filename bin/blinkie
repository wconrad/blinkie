#!/usr/bin/env ruby

require "gosu"
require "rmagick"

class GameWindow < Gosu::Window

  LED_OFF_COLOR = "#440000"
  LED_ON_COLOR = "#aa3300"

  def initialize
    super 640, 480
    self.caption = "Gosu Tutorial Game"
    @led_off_image = Gosu::Image.new(rmagick_circle(LED_ON_COLOR))
    @led_on_image = Gosu::Image.new(rmagick_circle(LED_OFF_COLOR))
    @count = 123
    Thread.new do
      loop do
        @count += 1
        sleep(0.1)
      end
    end
  end

  def needs_cursor?
    true
  end

  def update
  end

  def draw
    draw_background
    scale = 1.0
    x = 0
    15.downto(0).each do |i|
      bit = (@count >> i) & 1
      image = (bit == 1) ? @led_on_image : @led_off_image
      image.draw(x, 0, 0, scale, scale)
      x += image.width
    end
  end

  BACKGROUND_COLOR = 0xff_666666

  def draw_background
    color = Gosu::Color.argb(BACKGROUND_COLOR)
    Gosu.draw_rect(0, 0, width, height, color)
  end

  def draw_rect(x1, y1, x2, y2, color)
    draw_quad(
      0, 0, color,
      width, 0, color,
      0, height, color,
      width, height, color,
      0,
    )
  end

  def rmagick_circle(color)
    width = 32
    height = width
    image = Magick::Image.new(width, height) do
      self.background_color = "none"
    end
    gc = Magick::Draw.new
    origin_x = width / 2
    origin_y = height / 2
    perim_x = width / 2
    perim_y = 1
    gc.fill_color(color)
    gc.circle(origin_x, origin_y, perim_x, perim_y)
    gc.draw(image)
    image
  end

end

window = GameWindow.new
window.show
